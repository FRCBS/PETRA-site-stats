---
title: "Read site xlsx in and summarise"
author: "Mikko Arvas"
date: "`r Sys.time()`"
---

```{r setup, include=FALSE}
library(tidyverse)
library(WriteXLS)
library(readxl)
library(ggpubr)
library(patchwork)
library(ggplot2)
library(gtsummary)
library(here)

```

```{r}


#define parameters
param <- list()
param$wd <- here("src")
param$dd <- here("data")
param$rd <- here("results")

# fill more here .....

#create necessary directories if they don't exist
dir.create(param$dd, showWarnings = FALSE)
dir.create(param$rd, showWarnings = FALSE)
```


# Real data from all countries
After collecting xlsx from different countries read them in.


```{r}
# List all xlsx files that contain "Petra Data Collection" in their name from "data"
filenames <- list.files(here("data/"),pattern = ".*Petra Data Collection.*xlsx")
#delete any temporary copies from the names
filenames <- filenames[!str_detect(filenames,"~")]
filenames
```

```{r}

# Create abbrevations for sites

# THIS YOU HAVE TO DO BY HAND

# > filenames
# [1] "Copy of Petra Data Collection v03_NEMC North Estonia Medical Center (NEMC).xlsx" "Petra Data Collection Form Helsinki August 2025 Finland.xlsx"                   
# [3] "Petra Data Collection Scotland.xlsx" 

names(filenames) <- c(
  "NEMC",
  "HUS",
  "SCOT"
)
name2abbr <- names(filenames)
names(name2abbr) <-  filenames

```

Read "Site Info" in

```{r}
data<- filenames %>% 
  map(function(file_name){
    read_xlsx(
      path = here("data",file_name),
      sheet = "Site Info"
    ) %>% select(
      "Field", "Your site"
    ) %>% rename(
      #https://stackoverflow.com/questions/49650394/how-to-rename-a-variable-using-a-dynamic-name-and-dplyr
      !!as.character(name2abbr[file_name]) := "Your site"
      
      )
  }
  )

data <- data %>% 
  reduce(full_join, by = c("Field"))

```


Read "Transfusion Info" in

```{r}
tmp<- filenames %>% 
  map(function(file_name){
    read_xlsx(
      path = here("data",file_name),
      sheet = "Transfusion Info "
    ) %>% select(
      "Field", "All Patients"
    ) %>% rename(
      ##https://stackoverflow.com/questions/49650394/how-to-rename-a-variable-using-a-dynamic-name-and-dplyr
      !!as.character(name2abbr[file_name]) := "All Patients"
      
      )
  }
  )

tmp <- tmp %>% 
   reduce(full_join, by = c("Field"))

data <- bind_rows(data,tmp)

```



```{r}

WriteXLS(
  x = data,
  ExcelFileName = here("results","PETRA_Data_Collection.xlsx "),
  AdjWidth = TRUE,
  BoldHeaderRow = TRUE,
  FreezeRow = 1
  
)

```


# Summarise data


